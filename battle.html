<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Battle Arena</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages/battle.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="dashboard-header">
        <div class="nav-left">
            <img src="assets/logo-pokemon.png" alt="Logo">
        </div>
        <div class="nav-right">
            <a href="dashboard.html" class="logout-icon">
                <i class="fas fa-times-circle"></i>
            </a>
        </div>
    </header>

    <!-- Dark Overlay -->
    <div class="battle-overlay" id="battle-overlay"></div>

    <div class="battle-container" id="battle-container">
        
        <!-- Spotlight Effects -->
        <div class="spotlight-player" id="spotlight-player"></div>
        <div class="spotlight-bot" id="spotlight-bot"></div>
        
        <div class="scoreboard">
            <div style="text-align: center;">
                <div class="score-text" style="color: #00d2ff;">PLAYER</div>
                <div class="score-value player-score" id="player-score">0</div>
            </div>
            <div class="score-text" style="font-size: 30px; letter-spacing: 2px;">VS</div>
            <div style="text-align: center;">
                <div class="score-text" style="color: #ff4757;">ENEMY</div>
                <div class="score-value enemy-score" id="enemy-score">0</div>
            </div>
        </div>

        <div class="bot-area">
            <img src="assets/bot.png" alt="Giovanni Team Rocket" class="bot-char">
        </div>

        <div class="vs-text">VS</div>

        <!-- Skill Display Container -->
        <div class="skill-display-container" id="skill-display-container">
            <div>
                <div class="skill-display skill-display-player" id="player-skill-display">
                    <i class="fas fa-question"></i>
                </div>
                <div class="skill-label">PLAYER</div>
            </div>
            <div>
                <div class="skill-display skill-display-bot" id="bot-skill-display">
                    <i class="fas fa-question"></i>
                </div>
                <div class="skill-label">ENEMY</div>
            </div>
        </div>

        <div class="player-area">
            <img id="battle-trainer" src="" alt="Trainer" class="player-char">
        </div>

        <div class="battle-controls">
            <button class="btn-action btn-attack" title="Attack" id="btn-attack">
                <i class="fas fa-fire"></i>
            </button>
            <button class="btn-action btn-skill" title="Skill" id="btn-skill">
                <i class="fas fa-khanda"></i>
            </button>
            <button class="btn-action btn-defend" title="Defend" id="btn-defend">
                <i class="fas fa-shield-alt"></i>
            </button>
        </div>

        <div class="battle-result" id="battle-result"></div>

    </div>

    <!-- Win/Lose Modal -->
    <div class="battle-modal" id="battle-modal">
        <div class="modal-content" id="modal-content">
            <div class="modal-title" id="modal-title">YOU WIN!</div>
            
            <div class="battle-outcome" id="battle-outcome">
                <div class="outcome-icon" id="player-outcome-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="slash-effect" id="slash-effect"></div>
                <div class="outcome-icon" id="bot-outcome-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
            </div>

            <div class="modal-reward" id="modal-reward">You gained 500 XP!</div>

            <div class="modal-actions">
                <button class="modal-btn" id="btn-back-menu">Back To Menu</button>
                <button class="modal-btn" id="btn-play-again">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Ambil karakter yang dipilih
        const selectedChar = localStorage.getItem('selectedCharacter');
        
        const trainerImg = document.getElementById('battle-trainer');
        const pokemonImg = document.getElementById('battle-pokemon');

        // Logic penentuan gambar (Sesuai file yang kamu punya)
        if (selectedChar === 'candela') {
            trainerImg.src = 'assets/candela-removebg.png';
        } 
        else if (selectedChar === 'blanche') {
            trainerImg.src = 'assets/blanche-removebg.jpg';
        } 
        else if (selectedChar === 'spark') {
            trainerImg.src = 'assets/spark-removebg.jpg';
        } 
        else {
            // Default kalau belum pilih
            trainerImg.src = 'assets/candela-removebg.png';
        }

        // ===== BATTLE SYSTEM =====
        let playerScore = 0;
        let enemyScore = 0;
        let isBattleActive = false;

        const playerArea = document.querySelector('.player-area');
        const botArea = document.querySelector('.bot-area');
        const btnSkill = document.getElementById('btn-skill');
        const btnAttack = document.getElementById('btn-attack');
        const btnDefend = document.getElementById('btn-defend');
        const playerScoreEl = document.getElementById('player-score');
        const enemyScoreEl = document.getElementById('enemy-score');
        const battleResult = document.getElementById('battle-result');
        const battleOverlay = document.getElementById('battle-overlay');
        const battleContainer = document.getElementById('battle-container');
        const spotlightPlayer = document.getElementById('spotlight-player');
        const spotlightBot = document.getElementById('spotlight-bot');
        const skillDisplayContainer = document.getElementById('skill-display-container');
        const playerSkillDisplay = document.getElementById('player-skill-display');
        const botSkillDisplay = document.getElementById('bot-skill-display');

        // Sistem Rock-Paper-Scissors
        // Attack > Skill, Skill > Defend, Defend > Attack
        function determineWinner(playerChoice, botChoice) {
            if (playerChoice === botChoice) {
                return 'draw';
            }
            
            if (
                (playerChoice === 'attack' && botChoice === 'skill') ||
                (playerChoice === 'skill' && botChoice === 'defend') ||
                (playerChoice === 'defend' && botChoice === 'attack')
            ) {
                return 'player';
            }
            
            return 'bot';
        }

        // Fungsi untuk mendapatkan icon dan class berdasarkan choice
        function getSkillInfo(choice) {
            switch(choice) {
                case 'attack':
                    return { icon: 'fa-fire', class: 'attack-flash' };
                case 'skill':
                    return { icon: 'fa-khanda', class: 'skill-flash' };
                case 'defend':
                    return { icon: 'fa-shield-alt', class: 'defend-flash' };
                default:
                    return { icon: 'fa-question', class: '' };
            }
        }

        function getBotSkillInfo(choice) {
            switch(choice) {
                case 'attack':
                    return { icon: 'fa-fire', class: 'bot-attack-flash' };
                case 'skill':
                    return { icon: 'fa-khanda', class: 'bot-skill-flash' };
                case 'defend':
                    return { icon: 'fa-shield-alt', class: 'bot-defend-flash' };
                default:
                    return { icon: 'fa-question', class: '' };
            }
        }

        // Fungsi untuk bot random choice
        function getBotChoice() {
            const choices = ['attack', 'skill', 'defend'];
            return choices[Math.floor(Math.random() * choices.length)];
        }

        // Fungsi untuk disable/enable tombol
        function setButtonsEnabled(enabled) {
            btnSkill.disabled = !enabled;
            btnAttack.disabled = !enabled;
            btnDefend.disabled = !enabled;
        }

        // Fungsi untuk menampilkan hasil battle (quick flash)
        function showBattleResult(result) {
            battleResult.textContent = result;
            battleResult.className = 'battle-result show';
            
            if (result === 'WIN!') {
                battleResult.classList.add('result-win');
            } else if (result === 'LOSE!') {
                battleResult.classList.add('result-lose');
            } else {
                battleResult.classList.add('result-draw');
            }

            setTimeout(() => {
                battleResult.classList.remove('show');
                battleResult.className = 'battle-result';
            }, 1500);
        }

        // Variabel untuk modal
        const battleModal = document.getElementById('battle-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalReward = document.getElementById('modal-reward');
        const playerOutcomeIcon = document.getElementById('player-outcome-icon');
        const botOutcomeIcon = document.getElementById('bot-outcome-icon');
        const slashEffect = document.getElementById('slash-effect');
        const btnBackMenu = document.getElementById('btn-back-menu');
        const btnPlayAgain = document.getElementById('btn-play-again');

        // Fungsi untuk menampilkan modal win/lose
        function showBattleModal(result, playerChoice, botChoice) {
            const playerInfo = getSkillInfo(playerChoice);
            const botInfo = getBotSkillInfo(botChoice);
            
            // Set icon
            playerOutcomeIcon.innerHTML = `<i class="fas ${playerInfo.icon}"></i>`;
            botOutcomeIcon.innerHTML = `<i class="fas ${botInfo.icon}"></i>`;
            
            // Reset classes
            modalContent.className = 'modal-content';
            modalTitle.className = 'modal-title';
            modalReward.className = 'modal-reward';
            playerOutcomeIcon.className = 'outcome-icon';
            botOutcomeIcon.className = 'outcome-icon';
            
            if (result === 'WIN!') {
                modalContent.classList.add('modal-win');
                modalTitle.textContent = 'YOU WIN!';
                modalTitle.classList.add('win');
                modalReward.textContent = 'You gained 500 XP!';
                modalReward.classList.add('win');
                playerOutcomeIcon.classList.add('winner');
                botOutcomeIcon.classList.add('loser');
            } else if (result === 'LOSE!') {
                modalContent.classList.add('modal-lose');
                modalTitle.textContent = 'YOU LOSE!';
                modalTitle.classList.add('lose');
                modalReward.textContent = 'You lose 500 XP!';
                modalReward.classList.add('lose');
                playerOutcomeIcon.classList.add('loser');
                botOutcomeIcon.classList.add('winner');
            } else {
                modalContent.classList.add('modal-draw');
                modalTitle.textContent = 'DRAW!';
                modalTitle.classList.add('draw');
                modalReward.textContent = 'No XP gained or lost!';
                modalReward.classList.add('draw');
            }
            
            // Tampilkan slash effect
            slashEffect.style.display = 'block';
            setTimeout(() => {
                slashEffect.style.display = 'none';
            }, 500);
            
            // Buat overlay lebih gelap untuk modal
            battleOverlay.style.background = 'rgba(0, 0, 0, 0.85)';
            
            // Tampilkan modal
            battleModal.classList.add('show');
        }

        // Fungsi untuk menyembunyikan modal
        function hideBattleModal() {
            battleModal.classList.remove('show');
        }

        // Fungsi untuk reset battle setelah modal ditutup
        function resetBattle() {
            // Nonaktifkan dark overlay dan spotlight
            battleOverlay.classList.remove('active');
            battleOverlay.style.background = '';
            spotlightPlayer.classList.remove('active');
            spotlightBot.classList.remove('active');
            
            // Enable tombol lagi
            isBattleActive = false;
            setButtonsEnabled(true);
        }

        // Event listener untuk tombol modal
        btnBackMenu.addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        btnPlayAgain.addEventListener('click', () => {
            hideBattleModal();
            resetBattle();
        });

        // Fungsi untuk update skor
        function updateScore() {
            playerScoreEl.textContent = playerScore;
            enemyScoreEl.textContent = enemyScore;
        }

        // Fungsi untuk membuat energy burst effect
        function createEnergyBurst(isPlayer) {
            const burst = document.createElement('div');
            burst.className = `energy-burst ${isPlayer ? 'energy-burst-player' : 'energy-burst-bot'}`;
            battleContainer.appendChild(burst);
            
            setTimeout(() => {
                burst.remove();
            }, 1000);
        }

        // Fungsi untuk menampilkan skill yang dipilih
        function showSkillDisplay(playerChoice, botChoice) {
            const playerInfo = getSkillInfo(playerChoice);
            const botInfo = getBotSkillInfo(botChoice);
            
            playerSkillDisplay.innerHTML = `<i class="fas ${playerInfo.icon}"></i>`;
            botSkillDisplay.innerHTML = `<i class="fas ${botInfo.icon}"></i>`;
            
            skillDisplayContainer.classList.add('show');
        }

        // Fungsi untuk menyembunyikan skill display
        function hideSkillDisplay() {
            skillDisplayContainer.classList.remove('show');
        }

        // Fungsi battle utama
        async function performBattle(playerChoice) {
            if (isBattleActive) return;
            isBattleActive = true;
            setButtonsEnabled(false);

            // Bot random choice
            const botChoice = getBotChoice();
            
            // Aktifkan dark overlay dan spotlight
            battleOverlay.classList.add('active');
            spotlightPlayer.classList.add('active');
            spotlightBot.classList.add('active');

            // Tampilkan skill yang dipilih
            showSkillDisplay(playerChoice, botChoice);

            // Animasi tombol yang diklik
            const clickedBtn = document.getElementById(`btn-${playerChoice}`);
            clickedBtn.classList.add('skill-active');
            setTimeout(() => {
                clickedBtn.classList.remove('skill-active');
            }, 500);

            // Screen shake effect
            battleContainer.classList.add('shake');
            setTimeout(() => {
                battleContainer.classList.remove('shake');
            }, 500);

            // Player menggunakan skill - animasi warna + energy burst
            const playerInfo = getSkillInfo(playerChoice);
            playerArea.classList.add(playerInfo.class);
            createEnergyBurst(true);
            
            // Tunggu sebentar untuk animasi player
            await new Promise(resolve => setTimeout(resolve, 600));

            // Bot juga menggunakan skill - animasi warna + energy burst
            const botInfo = getBotSkillInfo(botChoice);
            botArea.classList.add(botInfo.class);
            createEnergyBurst(false);

            // Screen shake lagi saat bot attack
            battleContainer.classList.add('shake');
            setTimeout(() => {
                battleContainer.classList.remove('shake');
            }, 500);

            // Tunggu animasi bot selesai
            await new Promise(resolve => setTimeout(resolve, 1200));

            // Hapus class animasi
            playerArea.classList.remove('skill-flash', 'attack-flash', 'defend-flash');
            botArea.classList.remove('bot-skill-flash', 'bot-attack-flash', 'bot-defend-flash');

            // Tentukan pemenang berdasarkan rock-paper-scissors
            const winner = determineWinner(playerChoice, botChoice);
            let result;
            
            if (winner === 'player') {
                playerScore++;
                result = 'WIN!';
            } else if (winner === 'bot') {
                enemyScore++;
                result = 'LOSE!';
            } else {
                result = 'DRAW!';
            }

            // Update skor
            updateScore();

            // Tampilkan hasil quick flash
            showBattleResult(result);

            // Tunggu sebentar sebelum menampilkan modal
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Sembunyikan skill display
            hideSkillDisplay();

            // Tampilkan modal win/lose (overlay tetap aktif untuk efek gelap)
            showBattleModal(result, playerChoice, botChoice);
        }

        // Event listener untuk semua tombol
        btnAttack.addEventListener('click', () => {
            if (!isBattleActive) {
                performBattle('attack');
            }
        });

        btnSkill.addEventListener('click', () => {
            if (!isBattleActive) {
                performBattle('skill');
            }
        });

        btnDefend.addEventListener('click', () => {
            if (!isBattleActive) {
                performBattle('defend');
            }
        });

        // Inisialisasi skor
        updateScore();
    </script>

</body>
</html>